# gllm æ¶æ„è®¾è®¡

## å®šä½

**gllm = æ¨ç†å®¢æˆ·ç«¯åº“**

è´Ÿè´£æ¨¡å‹ç®¡ç†ã€é…ç½®ã€åˆ†è¯ã€æƒé‡åŠ è½½ï¼Œè°ƒç”¨ gllm-kernels åç«¯æ‰§è¡Œè®¡ç®—ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½

### ä¸‰ç§æ¨ç†ä»»åŠ¡

| ä»»åŠ¡ | æè¿° | æ¨¡å‹ç¤ºä¾‹ |
|------|------|----------|
| **Embedding** | æ–‡æœ¬å‘é‡åŒ– | BGE-M3, CodeXEmbed |
| **Rerank** | æ–‡æœ¬é‡æ’åº | BGE-Reranker |
| **Generator** | æ–‡æœ¬ç”Ÿæˆ | Qwen2, Mistral, MoE |

### å…¬å…± API

```rust
// åŒæ­¥/å¼‚æ­¥å®¢æˆ·ç«¯
pub struct Client { ... }
pub struct AsyncClient { ... }

// Builder æ¨¡å¼
client.embeddings(["text1", "text2"]).generate()
client.rerank("query", ["doc1", "doc2"]).generate()
client.generate("prompt").max_tokens(100).generate()
```

---

## æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  gllmï¼ˆå®¢æˆ·ç«¯ï¼‰                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Public API                                                     â”‚
â”‚  â”œâ”€â”€ Client / AsyncClient                                       â”‚
â”‚  â”œâ”€â”€ EmbeddingsBuilder / RerankBuilder / GenerateBuilder        â”‚
â”‚  â””â”€â”€ Types (Embedding, RerankResult, GenerationOutput)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Model Layer                                                    â”‚
â”‚  â”œâ”€â”€ Registry        â†’ åˆ«å â†” HF repo æ˜ å°„                      â”‚
â”‚  â”œâ”€â”€ Downloader      â†’ hf-hub ä¸‹è½½åˆ° ~/.gllm/models/            â”‚
â”‚  â”œâ”€â”€ model_config.rs â†’ æ¨¡å‹é…ç½®è§£æï¼ˆconfig.jsonï¼‰               â”‚
â”‚  â””â”€â”€ weight_loader.rs â†’ æƒé‡åŠ è½½ï¼ˆSafeTensors/GGUF/AWQï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Inference Layer                                                â”‚
â”‚  â”œâ”€â”€ engine.rs       â†’ æ¨ç†è°ƒåº¦ï¼ˆè°ƒç”¨ gllm-kernels Backendï¼‰     â”‚
â”‚  â”œâ”€â”€ generation.rs   â†’ ç”Ÿæˆå¾ªç¯æ§åˆ¶                              â”‚
â”‚  â””â”€â”€ kv_cache.rs     â†’ KV Cache ç®¡ç†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ è°ƒç”¨ Backend trait
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  gllm-kernelsï¼ˆåç«¯æœåŠ¡å™¨ï¼‰                                      â”‚
â”‚  â”œâ”€â”€ Backend traitï¼ˆ12 ä¸ª L2 å—çº§ç®—å­ï¼‰                         â”‚
â”‚  â””â”€â”€ CudaBackend / RocmBackend / MetalBackend / CpuBackend      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµ

### GPU åç«¯æ•°æ®æµï¼ˆğŸš¨ æ ¸å¿ƒåŸåˆ™ï¼‰

```
tokens â†’ uploadä¸€æ¬¡ â†’ [GPUå…¨ç¨‹è®¡ç®—] â†’ readbackä¸€æ¬¡ â†’ ç»“æœ
                      â†‘                            â†‘
                      â””â”€â”€â”€â”€ å…¨ç¨‹ GPU æ˜¾å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¦æ­¢**ï¼šä¸­é€” GPUâ†’CPUâ†’GPU å¾€è¿”

### æ¨¡å‹åŠ è½½æµç¨‹

```
Client::new("bge-m3")
    â†’ Registry è§£æåˆ«å â†’ "BAAI/bge-m3"
    â†’ æ£€æŸ¥ ~/.gllm/models/ æ˜¯å¦å­˜åœ¨
    â†’ ä¸å­˜åœ¨åˆ™ hf-hub ä¸‹è½½
    â†’ SafeTensors è§£ææƒé‡
    â†’ åˆå§‹åŒ–æ¨¡å‹ â†’ è¿”å› Client
```

#### æƒé‡åŠ è½½ç­–ç•¥ (ARCH-LOADER)

1.  **æ¶æ„è‡ªé€‚åº” (ARCH-LOADER-ADAPTIVE)**
    - Loader å¿…é¡»æ ¹æ® `Architecture` æšä¸¾è‡ªåŠ¨é€‰æ‹©æƒé‡å‘½åç­–ç•¥ã€‚
    - æ”¯æŒå‰ç¼€æ¢æµ‹ï¼ˆå¦‚ `bert.` vs æ— å‰ç¼€ï¼‰ã€‚

2.  **èåˆæƒé‡å¤„ç† (ARCH-LOADER-FUSED)**
    - é’ˆå¯¹ GPT-style (GPT-2, GPT-OSS) æ¨¡å‹ï¼Œå¿…é¡»æ”¯æŒ Fused QKV (`c_attn`) å’Œ Fused Projection (`c_fc`/`c_proj`) çš„è‡ªåŠ¨æ‹†åˆ†ã€‚
    - **ç¦æ­¢**ï¼šè¿è¡Œæ—¶åŠ¨æ€æ‹†åˆ†ï¼ˆè¿™ä¼šç ´åé›¶æ‹·è´åŸåˆ™ï¼‰ã€‚
    - **ç¦æ­¢**ï¼šå°†æ‹†åˆ†é€»è¾‘ä¸‹æ²‰è‡³ GPU Backendã€‚Backend æ¥å£åº”ä¿æŒæ•°å­¦ä¸Šçš„çº¯å‡€ï¼ˆç‹¬ç«‹ Q/K/Vï¼‰ï¼Œæ ¼å¼é€‚é…ç”± Loader å±‚è´Ÿè´£ã€‚
    - **è¦æ±‚**ï¼šåœ¨æƒé‡åŠ è½½é˜¶æ®µï¼ˆCPU -> GPU Upload å‰ï¼‰å®Œæˆæƒé‡çš„æ‹†åˆ†å’Œé‡æ’ï¼Œç¡®ä¿ GPU å†…æ ¸æ¥æ”¶åˆ°çš„æ˜¯æ ‡å‡†çš„ Q/K/V å’Œ Gate/Up/Down æ ¼å¼ã€‚

### æ¨ç†æµç¨‹

```
client.embeddings(["text"]).generate()
    â†’ Tokenizer ç¼–ç 
    â†’ Backend::embedding()      # GPU
    â†’ Backend::attention_block() # GPU (N å±‚)
    â†’ Backend::ffn_block()       # GPU (N å±‚)
    â†’ Backend::mean_pooling()    # GPU
    â†’ Backend::normalize()       # GPU
    â†’ readback â†’ è¿”å›ç»“æœ
```

---

## ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ lib.rs           # å…¬å…± API å¯¼å‡º
â”œâ”€â”€ client.rs        # Client / AsyncClient
â”œâ”€â”€ embeddings.rs    # Embeddings API
â”œâ”€â”€ rerank.rs        # Rerank API
â”œâ”€â”€ registry.rs      # åˆ«åæ³¨å†Œè¡¨
â”œâ”€â”€ engine.rs        # æ¨ç†å¼•æ“
â”œâ”€â”€ generation.rs    # ç”Ÿæˆå¾ªç¯
â”œâ”€â”€ kv_cache.rs      # KV Cache
â”œâ”€â”€ weight_loader.rs # æƒé‡åŠ è½½
â””â”€â”€ model_config.rs  # æ¨¡å‹é…ç½®
```

---

## å­˜å‚¨ç»“æ„

```
~/.gllm/models/
â”œâ”€â”€ BAAI--bge-m3/
â”‚   â”œâ”€â”€ model.safetensors
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ tokenizer.json
â””â”€â”€ Qwen--Qwen2-7B/
    â””â”€â”€ ...
```
